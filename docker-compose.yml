# ###################################
# This file is generated by puppet
# PLEASE DON'T MODIFY BY HAND
# ###################################

version: '2.1'
services:

  traefik:
    image: traefik:v1.4.1-alpine
    command: --web --docker --docker.domain=docker.localhost --logLevel=DEBUG
    ports:
      - "80:80"
      - "7071:8080"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/traefik/traefik.toml:/etc/traefik/traefik.toml:ro

  ########################
  # CHE
  ########################
  che:
    image: eclipse/che-server-multiuser:5.19.0
    env_file:
      - './config/che/che.env'
    environment:
      - "CHE_KEYCLOAK_AUTH__SERVER__URL=http://10.70.2.104/auth"
   #   - "CHE_PORT=80"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default
      - che-network
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './data:/data:rw'
      - './logs:/logs:rw'
      - './config/che:/conf'
     # - '/home/zagrebaev/git/che/assembly-multiuser/assembly-main/target/eclipse-che-5.19.0/eclipse-che-5.19.0:/assembly'
    ports:
      - '8080:8080'
      - '8000:8000'
    container_name: che
    labels:
      - "traefik.backend=che"
      - "traefik.backend.loadbalancer.sticky=true"
      - "traefik.frontend.rule=PathPrefix:/"
      - "traefik.port=8080"
      - "traefik.enable=true"

  ########################
  # POSTGRES
  ########################
  postgres:
    image: postgres:9.6
    environment:
      - POSTGRESQL_USER=keycloak
      - POSTGRESQL_PASSWORD=keycloak
      - POSTGRESQL_DATABASE=keycloak
      - CHE_POSTGRES_USERNAME=pgche
      - CHE_POSTGRES_PASSWORD=pgchepassword
      - CHE_POSTGRES_DATABASE=dbche
 
  
    volumes:
      - './data/postgres:/var/lib/postgresql/data'
      - './config/postgres/init-che-user.sh:/docker-entrypoint-initdb.d/init-che-user.sh'
    healthcheck:
        test: [ "CMD", "/bin/sh", "-i", "-c", "psql -h 127.0.0.1 -U keycloak -q -d keycloak -c 'SELECT 1'" ]
        interval: 10s
        timeout: 10s
        retries: 10
    labels:
    - "traefik.enable=false"

  ########################
  # KEYCLOAK
  ########################
  keycloak:
    image: jboss/keycloak-openshift:3.3.0.Final
    depends_on:
      postgres:
        condition: service_healthy
    #ports:
    # - '5050:8080'
    entrypoint:
      - start-keycloak.sh
      - -Dkeycloak.migration.action=import
      - -Dkeycloak.migration.provider=dir
      - -Dkeycloak.migration.strategy=IGNORE_EXISTING
      - -Dkeycloak.migration.dir=/opt/jboss/keycloak/realms/
      - -Djboss.bind.address=0.0.0.0
    environment:
      - POSTGRES_PORT_5432_TCP_ADDR=postgres
      - POSTGRES_PORT_5432_TCP_PORT=5432
      - POSTGRES_DATABASE=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
    volumes:
      - './config/keycloak/che:/opt/jboss/keycloak/themes/che'
      - './config/keycloak/:/opt/jboss/keycloak/realms/'
      #- './data/keycloak:/opt/jboss/keycloak/standalone/data:rw'
      #- './logs/keycloak:/opt/jboss/keycloak/standalone/log:rw'
    labels:
      - "traefik.backend=keycloak"
      - "traefik.backend.loadbalancer.sticky=true"
      - "traefik.frontend.rule=PathPrefix:/auth"
      - "traefik.port=8080"
      - "traefik.enable=true"  

networks:
  che-network:
