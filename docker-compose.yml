# ###################################
# This file is generated by puppet
# PLEASE DON'T MODIFY BY HAND
# ###################################

version: '2.1'
services:

  ########################
  # CHE
  ########################
  che:
    image: eclipse/che-server-multiuser:5.19.0
    env_file:
      - './config/che/che.env'
    links:
      - postgres:postgres
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default
      - che-network
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './data:/data:rw'
      - './logs:/logs:rw'
      - './config/che:/conf'
      - '/home/zagrebaev/git/che/assembly-multiuser/assembly-main/target/eclipse-che-5.19.0/eclipse-che-5.19.0:/assembly'
    ports:
      - '8080:8080'
      - '8000:8000'
    container_name: che


  ########################
  # POSTGRES
  ########################
  postgres:
    image: postgres:9.6
    environment:
      - POSTGRESQL_USER=keycloak
      - POSTGRESQL_PASSWORD=keycloak
      - POSTGRESQL_DATABASE=keycloak
      - CHE_POSTGRES_USERNAME=pgche
      - CHE_POSTGRES_PASSWORD=pgchepassword
      - CHE_POSTGRES_DATABASE=dbche
 
  
    volumes:
      - './data/postgres:/var/lib/pgsql/data:rw'
      - './config/postgres/init-che-user.sh:/docker-entrypoint-initdb.d/init-che-user.sh'
    healthcheck:
        test: [ "CMD", "/bin/sh", "-i", "-c", "psql -h 127.0.0.1 -U keycloak -q -d keycloak -c 'SELECT 1'" ]
        interval: 10s
        timeout: 10s
        retries: 10

  ########################
  # KEYCLOAK
  ########################
  keycloak:
    image: jboss/keycloak-openshift:3.3.0.Final
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - '5050:8080'
    entrypoint:
      - start-keycloak.sh
      - -Dkeycloak.migration.action=import
      - -Dkeycloak.migration.provider=dir
      - -Dkeycloak.migration.strategy=IGNORE_EXISTING
      - -Dkeycloak.migration.dir=/opt/jboss/keycloak/realms/
      - -Djboss.bind.address=0.0.0.0
    environment:
      - POSTGRES_PORT_5432_TCP_ADDR=postgres
      - POSTGRES_PORT_5432_TCP_PORT=5432
      - POSTGRES_DATABASE=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=keycloak
    volumes:
      - './config/keycloak/che:/opt/jboss/keycloak/themes/che'
      - './config/keycloak/:/opt/jboss/keycloak/realms/'
      #- './data/keycloak:/opt/jboss/keycloak/standalone/data:rw'
      #- './logs/keycloak:/opt/jboss/keycloak/standalone/log:rw'

networks:
  che-network:
